<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="dashboardSuporte.css">
  <link rel="shortcut icon" href="./assets/logo.png" type="image/x-icon">
  <script src="script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Dashboard | Home</title>
</head>

<body onload="obterDadosGrafico(), aguardarCarregamento()">
  <section class="navbar">
    <div class="logo">
      <img src="assets/logo.png" alt="">
    </div>
    <nav>
      <li><a href="">
          <img src="assets/casa.png" alt="">
        </a></li>
    </nav>
    <div class="logout">
      <li><a href="../login.html">
          <img src="assets/sair.png" alt="">
        </a></li>
    </div>
  </section>

  <main>
    <section class="sectionPerfil" onclick="entrarPerfil()">
      <div class="containerPerfil">
        <div class="contentImage" id="imageUser">

        </div>
        <div class="contentName">
          <p id="nameUser">Marcelo A.</p>
        </div>
      </div>
    </section>
    <section class="sectionKPI">
      <div class="GroupKPI">
        <div class="containerKPI">
          <img src="assets/cpu-do-computador.png" alt="">
          <div class="contentHorizontal">
            <h1>CPU</h1>
          </div>
          <div class="contentVertical">
            <p>% de utilização</p>
          </div>
          <div class="contentVerticalParametro">
            <p id="dadosCpu"><span>%</span></p>
          </div>
        </div>
        <div class="containerGrafico">
          <div class="contentGrafico">
            <canvas id="kpi"></canvas>
          </div>
        </div>
        <div class="containerKPI">
          <img src="assets/cartao-de-memoria.png" alt="">
          <div class="containerKPI1">
            <div class="contentHorizontal">
              <!-- <img src="assets/cpu-do-computador.png" alt=""> -->
              <h1>Memória</h1>
            </div>
            <div class="contentVertical">
              <p>% de utilização</p>
            </div>
            <div class="contentVerticalParametro">
              <p id="dadosMemoria"><span>%</span></p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="sectionTelas">
      <div class="primeiroGrupo">
        <div onclick="tela1()" class="containerTela" style=" border-bottom: red 5px solid;" id="card c1">
          <p class="date">Dezembro 20, 2021</p>
          <div class="contentVerticalTelas">
            <h1>Máquina 1</h1>
          </div>
          <p class="hours">09:25</p>
        </div>
        <div onclick="tela2()" class="containerTela" style=" border-bottom: red 5px solid;" id="card c2">
          <p class="date">Dezembro 20, 2021</p>
          <div class="contentVerticalTelas">
            <h1>Máquina 2</h1>
          </div>
          <p class="hours">09:25</p>
        </div>
        <div onclick="tela3()" class="containerTela" style=" border-bottom: red 5px solid;" id="card c3">
          <p class="date">Dezembro 20, 2021</p>
          <div class="contentVerticalTelas">
            <h1>Máquina 3</h1>
          </div>
          <p class="hours">09:25</p>
        </div>
        <div onclick="tela4()" class="containerTela" style=" border-bottom: red 5px solid;" id="card c4">
          <p class="date">Dezembro 20, 2021</p>
          <div class="contentVerticalTelas">
            <h1>Máquina 4</h1>
          </div>
          <p class="hours">09:25</p>
        </div>
      </div>
    </section>
  </main>
</body>

</html>

<script>
  // Gráfico KPI
  window.onload = function () {
        obterDadosGrafico(1, 1);
        obterDadosGrafico(2, 2);
        obterDadosGrafico(3, 3)
        obterDadosGrafico(4, 4);
    };

    function aguardarCarregamento() {
        setInterval(function () {
            obterDadosGrafico(1, 1);
            obterDadosGrafico(2, 2);
            obterDadosGrafico(3, 3);
            obterDadosGrafico(4, 4);
        }, 2000);
        setTimeout(aguardarCarregamento, 8000)
    }

    function obterDadosGrafico(idNotebook, idGrafico) {
        fetch(`/medidas/ultimas/${idNotebook}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    plotarGrafico(resposta, idNotebook, idGrafico);

                    const porcentagemUsoMemoria = resposta[0].porcentagemUsoMemoria;
                    const porcentagemUsoProcessador = resposta[0].porcentagemUsoProcessador;

                    if (idGrafico === 1) {
                        tela1(porcentagemUsoMemoria, porcentagemUsoProcessador);
                    } else if (idGrafico === 2) {
                        tela2(porcentagemUsoMemoria, porcentagemUsoProcessador);
                    } else if (idGrafico === 3) {
                        tela3(porcentagemUsoMemoria, porcentagemUsoProcessador);
                    } else if (idGrafico === 4) {
                        tela4(porcentagemUsoMemoria, porcentagemUsoProcessador);
                    }
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta, idNotebook, idGrafico) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Produtividade',
                data: [],
                fill: 'start',
                borderColor: 'rgb(0,0,255)',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        let quantidadeAlerta = 0;
        let quantidadeNormal = 0;
        let quantidadeCritico = 0;

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            var produtividadeAtual = (registro.porcentagemUsoMemoria + registro.porcentagemUsoProcessador) / 2;
            dados.datasets[0].data.push(produtividadeAtual);

            if (produtividadeAtual >= 0 && produtividadeAtual <= 24) {
                quantidadeAlerta++;
            } else if (produtividadeAtual >= 25 && produtividadeAtual <= 60) {
                quantidadeNormal++;
            } else if (produtividadeAtual >= 61 && produtividadeAtual <= 95) {
                quantidadeCritico++;
            }
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        const ctx = document.getElementById('kpi');
        let myChart = new Chart({
            type: 'pie',
            data: {
                datasets: [{
                    label: 'Quantidade',
                    data: [quantidadeNormal, quantidadeAlerta, quantidadeCritico],
                    borderWidth: 1,
                    backgroundColor: [
                        'rgb(36, 224, 96)',
                        'rgb(240, 217, 46)',
                        'rgb(250, 77, 77)'
                    ],
                }],
                labels: ['Produtivo', 'Alerta', 'Crítico']
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        setTimeout(() => atualizarGrafico(idNotebook, dados, myChart, idGrafico), 2000);
    }

    function atualizarGrafico(idNotebook, dados, myChart, idGrafico) {
        fetch(`/medidas/tempo-real/${idNotebook}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        // document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."

                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        var produtividadeAtual = (registro.percentagemUsoMemoria + registro.porcentagemUsoProcessador) / 2;
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento
                        dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[0].data.push(novoRegistro[0].produtividadeAtual); // incluir uma nova medida de temperatura
                        myChart.update();
                    }
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idNotebook, dados, myChart, idGrafico), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idNotebook, dados, myChart, idGrafico), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    
    function tela1(porcentagemUsoMemoria, porcentagemUsoProcessador) {
      const dadosCpu = document.getElementById('dadosCpu');
      const dadosMemoria = document.getElementById('dadosMemoria');
      dadosCpu.innerHTML = porcentagemUsoMemoria;
      dadosMemoria.innerHTML = porcentagemUsoProcessador;
    } 

    function tela2(porcentagemUsoMemoria, porcentagemUsoProcessador) {
      const dadosCpu = document.getElementById('dadosCpu');
      const dadosMemoria = document.getElementById('dadosMemoria');
      dadosCpu.innerHTML = `${porcentagemUsoMemoria}`;
      dadosMemoria.innerHTML = `${porcentagemUsoProcessador}`;
    } 

    function tela3(porcentagemUsoMemoria, porcentagemUsoProcessador) {
      const dadosCpu = document.getElementById('dadosCpu');
      const dadosMemoria = document.getElementById('dadosMemoria');
      dadosCpu.innerHTML = `${porcentagemUsoMemoria}`;
      dadosMemoria.innerHTML = `${porcentagemUsoProcessador}`;
    } 

    function tela4(porcentagemUsoMemoria, porcentagemUsoProcessador) {
      const dadosCpu = document.getElementById('dadosCpu');
      const dadosMemoria = document.getElementById('dadosMemoria');
      dadosCpu.innerHTML = `${porcentagemUsoMemoria}`;
      dadosMemoria.innerHTML = `${porcentagemUsoProcessador}`;
    } 

  // function alertar(temperatura, idDadosCapturados) {
  //   var limites = {x
  //     alerta: 24,
  //     normal: 60,
  //     critico: 95,
      
  //   };

  //   var classeDados = 'card';

  //   if (temperatura >= limites.critico) {
  //     classeDados = 'card critico';
  //     console.log("caiu no 1")
  //   } else if (temperatura < limites.alerta) {
  //     classeDados = 'card alerta';
  //     console.log("caiu no 2")
  //   } else if (temperatura < limites.normal) {
  //     classeDados = 'card ideal';
  //     console.log("caiu no 3")
  //   } 

  //   var card;

  //   if (idDadosCapturados == 1) {
  //     dadosCpu.innerHTML = temperatura;
  //     card = card_1
  //   } else if (idDadosCapturados == 2) {
  //     dadosMemoria.innerHTML = temperatura;
  //     card = card_2
  //   }

  //   // alterando
  //   card.className = classeDados;
  // }
</script>